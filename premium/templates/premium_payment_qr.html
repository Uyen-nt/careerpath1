{% extends 'base.html' %}
{% load static %}
{% load humanize %}
{% block title %}Thanh Toán Premium - CareerPath{% endblock %}

{% block content %}
<section class="premium-section text-center py-5">
    <div class="container">
        <h2 class="fw-bold mb-3">Thanh Toán Premium</h2>
        <p class="lead mb-4">Vui lòng thực hiện thanh toán <strong>{{ amount|intcomma }}₫</strong> cho gói {{ months }} tháng Premium.</p>
        
        <div id="payment-info" style="display: none;">
            <p>Mã giao dịch: <strong id="order-id"></strong></p>
            <h4 class="mb-3">Thông tin thanh toán</h4>
            <p>
                Ngân hàng: <strong id="bank-name"></strong><br>
                Số tài khoản: <strong id="account-number"></strong><br>
                Chủ tài khoản: <strong id="account-name"></strong><br>
                Nội dung chuyển khoản: <strong id="description"></strong>
            </p>
            <img id="qr-code" alt="QR Code thanh toán" class="img-fluid" style="max-width: 300px; display: none;">
            <p class="mt-4 text-muted">Sau khi thanh toán, hệ thống sẽ tự động xác nhận và kích hoạt Premium. Vui lòng chờ...</p>
            <div id="success-message" style="display: none;" class="alert alert-success">Thanh toán thành công! Premium đã được kích hoạt. Bạn sẽ nhận email xác nhận.</div>
            <div id="error-message" style="display: none;" class="alert alert-danger">Thanh toán thất bại. Vui lòng thử lại.</div>
        </div>
        
        <button id="pay-button" class="btn btn-success btn-lg">Thanh toán</button>
        <a href="{% url 'home' %}" class="btn btn-secondary mt-3">Quay về trang chủ</a>
    </div>
</section>

<script>
document.getElementById('pay-button').addEventListener('click', function() {
    const button = this;
    button.disabled = true;
    button.textContent = 'Đang xử lý...';

    fetch("{% url 'premium:initiate_payment' %}", {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}',
        },
        body: JSON.stringify({
            months: {{ months }},
        })
    })
    .then(response => response.json())
    .then(data => {
        button.disabled = false;
        button.style.display = 'none';

        if (data.status === 'success') {
            document.getElementById('payment-info').style.display = 'block';
            document.getElementById('order-id').textContent = data.order_id;
            document.getElementById('bank-name').textContent = data.bank_name;
            document.getElementById('account-number').textContent = data.account_number;
            document.getElementById('account-name').textContent = data.account_name;
            document.getElementById('description').textContent = data.description;
            document.getElementById('qr-code').src = 'data:image/png;base64,' + data.qr_code;
            document.getElementById('qr-code').style.display = 'block';

            // Poll status every 5 seconds
            const orderId = data.order_id;
            const interval = setInterval(() => {
                fetch(`{% url 'premium:check_payment' 'dummy' %}`.replace('dummy', orderId))
                .then(res => res.json())
                .then(statusData => {
                    if (statusData.status === 'completed') {
                        document.getElementById('success-message').style.display = 'block';
                        clearInterval(interval);
                        setTimeout(() => { window.location.href = '{% url "premium:premium_home" %}'; }, 5000);  // Redirect sau 5s
                        } else if (statusData.status === 'failed') {
                        document.getElementById('error-message').style.display = 'block';
                        clearInterval(interval);                    
                    }
                });
            }, 5000);
        } else {
            alert('Lỗi: ' + data.message);
            button.textContent = 'Thanh toán';
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Đã xảy ra lỗi. Vui lòng thử lại.');
        button.disabled = false;
        button.textContent = 'Thanh toán';
    });
});
</script>
{% endblock %}