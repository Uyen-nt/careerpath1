{% extends "base.html" %}
{% load static %}
{% block title %}K·∫øt Qu·∫£ Tr·∫Øc Nghi·ªám - CareerPath{% endblock %}

{% block content %}
<link rel="stylesheet" href="{% static 'css/quiz_highschool.css' %}">

<main class="result-page section-padding">

  <!-- KHUNG TR·∫ÆNG S·ªê 1: K·∫æT QU·∫¢ -->
  <div class="container result-container">
    <h2 class="result-heading">üéØ B√°o C√°o K·∫øt Qu·∫£ Tr·∫Øc Nghi·ªám Ch·ªçn Ng√†nh</h2>
    <div class="section-divider"></div>

    <div class="tabs">
      <button class="tab active" onclick="showTab('overview')" aria-label="Xem t·ªïng quan k·∫øt qu·∫£">‚úÖ T·ªïng Quan</button>
      <button class="tab" onclick="showTab('analysis')" aria-label="Xem ph√¢n t√≠ch chi ti·∫øt">üìä Ph√¢n T√≠ch</button>
    </div>

    <div class="tab-content-wrapper">
      <!-- N·ªôi dung c√°c tab k·∫øt qu·∫£... -->
      <div id="overview" class="tab-content active">
        <div class="result-wrapper">
          <div class="result-bars">
            {% for cluster, percentage in cluster_percentages.items %}
            <div class="result-bar">
              <div class="label">‚Ä¢ Nh√≥m {{ cluster }}: <span class="percentage">{{ percentage }}%</span></div>
              <div class="bar"><div class="fill" style="width:{{ percentage }}%;" data-percentage="{{ percentage }}"></div></div>
            </div>
            {% endfor %}
          </div>
          <div class="profile-spotlight-wrapper">
              {{ top_card_html|safe }}
              {{ second_card_html|safe }}
          </div>
        </div>
      </div>
      <div id="analysis" class="tab-content">
        <!-- N·ªôi dung tab ph√¢n t√≠ch... -->
        <div class="analysis-polished-layout">
          <div class="vertical-nav-polished">
            <div class="nav-header-polished">
              <i class="fas fa-flag-checkered"></i>
              <h6>L·ªô Tr√¨nh C·ªßa B·∫°n</h6>
            </div>
            <button class="v-nav-item-polished active" onclick="switchVerticalTab(event, 'v-group1')">
              <i class="fas fa-briefcase nav-icon-main"></i>
              <div class="v-nav-text">
                <span class="v-nav-rank">L·ª±a ch·ªçn #1</span>
                <span class="v-nav-name">{{ top_cluster_name }}</span>
              </div>
            </button>
            <button class="v-nav-item-polished" onclick="switchVerticalTab(event, 'v-group2')">
              <i class="fas fa-microchip nav-icon-main"></i>
              <div class="v-nav-text">
                <span class="v-nav-rank">L·ª±a ch·ªçn #2</span>
                <span class="v-nav-name">{{ second_cluster_name }}</span>
              </div>
            </button>
          </div>
          <div class="vertical-content-area-polished">
            <div id="v-group1" class="v-content-pane active">
              <div class="pane-header-polished group-1-theme">
                {{ top_analysis_html|safe }}
              </div>
            </div>
            <div id="v-group2" class="v-content-pane">
              <div class="pane-header-polished group-2-theme">
                {{ second_analysis_html|safe }}
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>


  <!-- KHUNG TR·∫ÆNG S·ªê 2: ƒê√ÅNH GI√Å (GIAO DI·ªÜN V4 - COMPACT FORM) -->
  <div class="container" id="final-evaluation">
      <!-- Wrapper m·ªõi cho form nh·ªè g·ªçn -->
      <div class="feedback-compact-form-v4"
          data-quiz-type="{{ quiz_type|default:'highschool' }}"
          data-quiz-id="{{ quiz_id|default:'' }}">

          <!-- H√†ng 1: C√°c ng√¥i sao -->
          <div class="stars" role="radiogroup" aria-label="ƒê√°nh gi√° 1 ƒë·∫øn 5 sao">
              <button type="button" class="star" aria-checked="false" aria-label="1 sao" data-rating="1">‚òÖ</button>
              <button type="button" class="star" aria-checked="false" aria-label="2 sao" data-rating="2">‚òÖ</button>
              <button type="button" class="star" aria-checked="false" aria-label="3 sao" data-rating="3">‚òÖ</button>
              <button type="button" class="star" aria-checked="false" aria-label="4 sao" data-rating="4">‚òÖ</button>
              <button type="button" class="star" aria-checked="false" aria-label="5 sao" data-rating="5">‚òÖ</button>
              <span class="rating-text">B·∫°n th·∫•y h·ªØu √≠ch ch·ª©?</span>
          </div>

          <!-- H√†ng 2: √î comment v√† n√∫t g·ª≠i -->
          <div class="comment-action-wrapper-v4">
              <div class="input-wrapper-v4">
                  <i class="fas fa-pen input-icon-v4"></i>
                  <!-- Input gi·ªù c√≥ placeholder l√† m·ªôt kho·∫£ng tr·∫Øng -->
                  <input type="text" id="fb-comment" maxlength="500" placeholder=" " aria-label="N·ªôi dung ƒë√°nh gi√°">
                  <!-- Label m·ªõi ƒë∆∞·ª£c th√™m v√†o ƒë·ªÉ t·∫°o hi·ªáu ·ª©ng -->
                  <label for="fb-comment" class="floating-label">Chia s·∫ª tr·∫£i nghi·ªám c·ªßa b·∫°n...</label>
              </div>
              <button id="fb-submit" class="btn-submit-v4" disabled>
                  <span class="loading" hidden></span>
                  <span>G·ª≠i</span>
              </button>
          </div>
          
          <span id="fb-status" class="muted" role="status" aria-live="polite"></span>
      </div>
  </div>

</main> 
<div id="toast-container"></div>

<script>
  function showTab(tabId) {
    const tabs = document.querySelectorAll(".tab");
    const contents = document.querySelectorAll(".tab-content");
    tabs.forEach(btn => btn.classList.remove("active"));
    contents.forEach(c => {
      c.classList.remove("active");
      c.style.opacity = "0";
    });
    const selectedTab = document.querySelector(`.tab[onclick="showTab('${tabId}')"]`);
    const selectedContent = document.getElementById(tabId);
    selectedTab.classList.add("active");
    selectedContent.classList.add("active");
    setTimeout(() => {
      selectedContent.style.opacity = "1";
    }, 50);
  }

  document.addEventListener("DOMContentLoaded", () => {
    document.querySelectorAll(".fill").forEach(bar => {
      const percentage = bar.dataset.percentage;
      bar.style.width = "0%";
      setTimeout(() => {
        bar.style.width = `${percentage}%`;
      }, 300);
    });
  });

  function switchVerticalTab(event, paneId) {
    document.querySelectorAll('.v-content-pane').forEach(pane => {
      pane.classList.remove('active');
    });
    document.querySelectorAll('.v-nav-item-polished').forEach(btn => {
      btn.classList.remove('active');
    });
    const activePane = document.getElementById(paneId);
    activePane.classList.add('active');
    event.currentTarget.classList.add('active');
    animateProgressCircle(activePane);
  }

  function animateProgressCircle(pane) {
    const wrapper = pane.querySelector('.progress-circle-wrapper');
    if (!wrapper) return;
    const score = parseInt(wrapper.dataset.score, 10);
    const indicator = wrapper.querySelector('.progress-ring-indicator');
    const radius = indicator.r.baseVal.value;
    const circumference = 2 * Math.PI * radius;
    const offset = circumference - (score / 100) * circumference;
    indicator.style.strokeDasharray = `${circumference} ${circumference}`;
    indicator.style.strokeDashoffset = circumference;
    setTimeout(() => {
      indicator.style.strokeDashoffset = offset;
    }, 10);
  }

  document.addEventListener('DOMContentLoaded', () => {
    const initialActivePane = document.querySelector('.v-content-pane.active');
    if (initialActivePane) {
      animateProgressCircle(initialActivePane);
    }
  });

  function switchSpotlightCard(cardIdToShow) {
    const allCards = document.querySelectorAll('.profile-spotlight-card');
    allCards.forEach(card => {
      card.classList.remove('active');
    });
    const cardToShow = document.getElementById(cardIdToShow);
    if (cardToShow) {
      cardToShow.classList.add('active');
    }
  }
  function restructurePaneContent(paneElement) {
    // 1. T√¨m th·∫ª cha ch·ª©a header c√≥ m√†u n·ªÅn
    const headerContainer = paneElement.querySelector('.pane-header-polished');
    if (!headerContainer) return; // N·∫øu kh√¥ng c√≥ th√¨ tho√°t

    // 2. T√¨m c√°c ph·∫ßn content ƒëang n·∫±m sai v·ªã tr√≠ (b√™n trong header)
    const contentList = headerContainer.querySelector('.analysis-step-list');
    const conclusion = headerContainer.querySelector('.analysis-conclusion');

    // 3. Di chuy·ªÉn c√°c ph·∫ßn content n√†y ra ngo√†i, l√†m con c·ªßa th·∫ª v-content-pane
    // JS s·∫Ω t·ª± ƒë·ªông di chuy·ªÉn ph·∫ßn t·ª≠ t·ª´ v·ªã tr√≠ c≈© sang v·ªã tr√≠ m·ªõi
    if (contentList && !contentList.parentElement.classList.contains('v-content-pane')) {
      paneElement.appendChild(contentList);
    }
    if (conclusion && !conclusion.parentElement.classList.contains('v-content-pane')) {
      paneElement.appendChild(conclusion);
    }
  }

  // --- C√ÅC H√ÄM C≈® ƒê∆Ø·ª¢C C·∫¨P NH·∫¨T ---

  function showTab(tabId) {
    const tabs = document.querySelectorAll(".tab");
    const contents = document.querySelectorAll(".tab-content");
    tabs.forEach(btn => btn.classList.remove("active"));
    contents.forEach(c => {
      c.classList.remove("active");
      c.style.opacity = "0";
    });
    const selectedTab = document.querySelector(`.tab[onclick="showTab('${tabId}')"]`);
    const selectedContent = document.getElementById(tabId);
    selectedTab.classList.add("active");
    selectedContent.classList.add("active");
    setTimeout(() => {
      selectedContent.style.opacity = "1";
    }, 50);
  }

  function switchVerticalTab(event, paneId) {
    document.querySelectorAll('.v-content-pane').forEach(pane => {
      pane.classList.remove('active');
    });
    document.querySelectorAll('.v-nav-item-polished').forEach(btn => {
      btn.classList.remove('active');
    });
    const activePane = document.getElementById(paneId);
    activePane.classList.add('active');
    event.currentTarget.classList.add('active');
    
    // C·∫¨P NH·∫¨T: G·ªçi h√†m t√°i c·∫•u tr√∫c cho tab v·ª´a ƒë∆∞·ª£c click
    restructurePaneContent(activePane); 

    animateProgressCircle(activePane);
  }

  function animateProgressCircle(pane) {
    const wrapper = pane.querySelector('.progress-circle-wrapper');
    if (!wrapper) return;
    const scoreText = wrapper.dataset.score || "0";
    const score = parseInt(scoreText.replace('%',''), 10);
    const indicator = wrapper.querySelector('.progress-ring-indicator');
    if (!indicator) return;
    const radius = indicator.r.baseVal.value;
    const circumference = 2 * Math.PI * radius;
    const offset = circumference - (score / 100) * circumference;
    indicator.style.strokeDasharray = `${circumference} ${circumference}`;
    indicator.style.strokeDashoffset = circumference;
    setTimeout(() => {
      indicator.style.strokeDashoffset = offset;
    }, 10);
  }

  function switchSpotlightCard(cardIdToShow) {
    const allCards = document.querySelectorAll('.profile-spotlight-card');
    allCards.forEach(card => {
      card.classList.remove('active');
    });
    const cardToShow = document.getElementById(cardIdToShow);
    if (cardToShow) {
      cardToShow.classList.add('active');
    }
  }

  // --- H√ÄM CH·∫†Y KHI T·∫¢I TRANG ---
  document.addEventListener("DOMContentLoaded", () => {
    // Ch·∫°y animation cho thanh ti·∫øn tr√¨nh ngang
    document.querySelectorAll(".fill").forEach(bar => {
      const percentage = bar.dataset.percentage;
      bar.style.width = "0%";
      setTimeout(() => {
        bar.style.width = `${percentage}%`;
      }, 300);
    });

    // C·∫¨P NH·∫¨T: T√¨m tab ƒëang active l√∫c t·∫£i trang v√† t√°i c·∫•u tr√∫c n√≥
    const initialActivePane = document.querySelector('.v-content-pane.active');
    if (initialActivePane) {
      restructurePaneContent(initialActivePane); // T√°i c·∫•u tr√∫c cho tab ƒë·∫ßu ti√™n
      animateProgressCircle(initialActivePane);   // Ch·∫°y animation v√≤ng tr√≤n
    }
  });


// =======================================================
// === SCRIPT M·ªöI: TOAST NOTIFICATION & ƒê√ÅNH GI√Å ===
// =======================================================

/**
 * Hi·ªÉn th·ªã m·ªôt th√¥ng b√°o Toast
 * @param {string} message - N·ªôi dung th√¥ng b√°o
 * @param {string} type - Lo·∫°i th√¥ng b√°o ('success' ho·∫∑c 'error')
 * @param {number} duration - Th·ªùi gian hi·ªÉn th·ªã (ms)
 */
function showToast(message, type = 'success', duration = 5000) {
    const container = document.getElementById('toast-container');
    if (!container) return;

    const toast = document.createElement('div');
    toast.className = `toast ${type}`;

    const icons = {
        success: '<i class="fas fa-check-circle"></i>',
        error: '<i class="fas fa-times-circle"></i>'
    };
    
    const titles = {
        success: 'Th√†nh c√¥ng!',
        error: 'C√≥ l·ªói x·∫£y ra!'
    }

    toast.innerHTML = `
        <div class="toast-icon">${icons[type]}</div>
        <div class="toast-content">
            <div class="title">${titles[type]}</div>
            <div class="message">${message}</div>
        </div>
        <button class="toast-close">&times;</button>
        <div class="toast-progress-bar"></div>
    `;

    container.appendChild(toast);

    // K√≠ch ho·∫°t animation
    setTimeout(() => {
        toast.classList.add('show');
    }, 100);

    // T·ª± ƒë·ªông ƒë√≥ng
    const timeoutId = setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => toast.remove(), 500); // X√≥a kh·ªèi DOM sau khi animation k·∫øt th√∫c
    }, duration);

    // ƒê√≥ng khi click n√∫t close
    toast.querySelector('.toast-close').addEventListener('click', () => {
        clearTimeout(timeoutId); // H·ªßy t·ª± ƒë·ªông ƒë√≥ng
        toast.classList.remove('show');
        setTimeout(() => toast.remove(), 500);
    });
}


// Logic x·ª≠ l√Ω form ƒë√°nh gi√° (PHI√äN B·∫¢N S·ª¨A L·ªñI CHO GIAO DI·ªÜN V4)
(function() {
    // Thay ƒë·ªïi selector ƒë·ªÉ tr·ªè ƒë√∫ng v√†o wrapper c·ªßa form V4
    const wrap = document.querySelector('.feedback-compact-form-v4');
    if (!wrap) return;

    // L·∫•y c√°c thu·ªôc t√≠nh data t·ª´ wrapper
    const quizType = wrap.dataset.quizType || "{{ quiz_type|default:'highschool' }}";
    const quizId = wrap.dataset.quizId || "{{ quiz_id|default:'' }}";

    // T√¨m c√°c ph·∫ßn t·ª≠ con b√™n trong wrapper
    const stars = wrap.querySelectorAll('.star');
    const submitBtn = wrap.querySelector('#fb-submit');
    const commentEl = wrap.querySelector('#fb-comment');
    const spinner = submitBtn.querySelector('.loading');
    const statusEl = wrap.querySelector('#fb-status');

    let rating = 0;

    // H√†m n√†y kh√¥ng c·∫ßn thay ƒë·ªïi
    function updateButtonState() {
        submitBtn.disabled = !(rating >= 1 && rating <= 5);
    }

    // H√†m x·ª≠ l√Ω click sao
    stars.forEach((btn, i) => {
        btn.addEventListener('click', () => {
            // L·∫•y rating t·ª´ data-attribute ho·∫∑c ch·ªâ s·ªë
            rating = parseInt(btn.dataset.rating, 10) || (i + 1);
            
            // C·∫≠p nh·∫≠t giao di·ªán sao
            stars.forEach((b, j) => {
                const currentRating = parseInt(b.dataset.rating, 10) || (j + 1);
                const active = currentRating <= rating;
                b.classList.toggle('active', active);
                b.setAttribute('aria-checked', active ? 'true' : 'false');
            });
            
            updateButtonState();
        });
    });

    // H√†m x·ª≠ l√Ω click n√∫t g·ª≠i
    submitBtn.addEventListener('click', async () => {
        if (!quizType || !quizId) {
            showToast('Thi·∫øu th√¥ng tin b√†i tr·∫Øc nghi·ªám ƒë·ªÉ ƒë√°nh gi√°.', 'error');
            return;
        }

        const comment = (commentEl.value || "").trim();
        submitBtn.disabled = true;
        spinner.hidden = false;
        if (statusEl) statusEl.textContent = ''; // X√≥a tr·∫°ng th√°i c≈©

        try {
            const res = await fetch("{% url 'quiz_highschool:save_feedback' %}", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": "{{ csrf_token }}"
                },
                body: JSON.stringify({
                    quiz_type: quizType,
                    quiz_id: Number(quizId),
                    rating,
                    comment
                })
            });
            const data = await res.json();
            
            if (res.ok && data.ok) {
                showToast('C·∫£m ∆°n b·∫°n ƒë√£ g·ª≠i ƒë√°nh gi√°!', 'success');
                
                // Reset form
                commentEl.value = "";
                rating = 0;
                stars.forEach(b => {
                    b.classList.remove('active');
                    b.setAttribute('aria-checked', 'false');
                });
                updateButtonState(); // V√¥ hi·ªáu h√≥a l·∫°i n√∫t g·ª≠i
            } else {
                showToast(data.message || 'G·ª≠i ƒë√°nh gi√° th·∫•t b·∫°i. Vui l√≤ng th·ª≠ l·∫°i.', 'error');
            }
        } catch (err) {
            console.error('Feedback submission error:', err); // Th√™m log l·ªói ƒë·ªÉ debug
            showToast('L·ªói k·∫øt n·ªëi m·∫°ng. Vui l√≤ng ki·ªÉm tra v√† th·ª≠ l·∫°i.', 'error');
        } finally {
            spinner.hidden = true;
            // K√≠ch ho·∫°t l·∫°i n√∫t n·∫øu G·ª¨I TH·∫§T B·∫†I V√Ä ƒê√É C√ì RATING
            // N·∫øu g·ª≠i th√†nh c√¥ng, n√∫t s·∫Ω b·ªã v√¥ hi·ªáu h√≥a b·ªüi updateButtonState()
            if (rating > 0 && !res.ok) {
                 submitBtn.disabled = false;
            }
        }
    });

    // G·ªçi l·∫ßn ƒë·∫ßu ƒë·ªÉ ƒë·∫£m b·∫£o n√∫t b·ªã v√¥ hi·ªáu h√≥a
    updateButtonState();
})();

</script>
{% endblock %}