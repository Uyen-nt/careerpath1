{% extends "base.html" %}
{% load static %}
{% block title %}K·∫øt Qu·∫£ Tr·∫Øc Nghi·ªám - CareerPath{% endblock %}

{% block content %}
<link rel="stylesheet" href="{% static 'css/quiz_highschool.css' %}">

<main class="result-page section-padding">
  <div class="container result-container">
    <h2 class="result-heading">üéØ B√°o C√°o K·∫øt Qu·∫£ Tr·∫Øc Nghi·ªám Ch·ªçn Ng√†nh</h2>
    <div class="section-divider"></div>

    <div class="tabs">
      <button class="tab active" onclick="showTab('overview')" aria-label="Xem t·ªïng quan k·∫øt qu·∫£">‚úÖ T·ªïng Quan</button>
      <button class="tab" onclick="showTab('analysis')" aria-label="Xem ph√¢n t√≠ch chi ti·∫øt">üìä Ph√¢n T√≠ch</button>
    </div>

    <div class="tab-content-wrapper">
      <div id="overview" class="tab-content active">
        <div class="result-wrapper">
          <div class="result-bars">
            {% for cluster, percentage in cluster_percentages.items %}
            <div class="result-bar">
              <div class="label">‚Ä¢ Nh√≥m {{ cluster }}: <span class="percentage">{{ percentage }}%</span></div>
              <div class="bar"><div class="fill" style="width:{{ percentage }}%;" data-percentage="{{ percentage }}"></div></div>
            </div>
            {% endfor %}
          </div>
          <!-- Card 2: Split-Panel "Overlap" Design - Carousel Wrapper -->
          <div class="profile-spotlight-wrapper">
              {{ top_card_html|safe }}
              {{ second_card_html|safe }}
          </div>
        </div>
      </div>

      <div id="analysis" class="tab-content">
        <div class="analysis-polished-layout">
          <!-- SIDEBAR -->
          <div class="vertical-nav-polished">
              <div class="nav-header-polished">
                  <i class="fas fa-flag-checkered"></i>
                  <h6>L·ªô Tr√¨nh C·ªßa B·∫°n</h6>
              </div>

              <button class="v-nav-item-polished active" onclick="switchVerticalTab(event, 'v-group1')">
                  <i class="fas fa-briefcase nav-icon-main"></i>
                  <div class="v-nav-text">
                      <span class="v-nav-rank">L·ª±a ch·ªçn #1</span>
                      <span class="v-nav-name">{{ top_cluster_name }}</span>
                  </div>
              </button>

              <button class="v-nav-item-polished" onclick="switchVerticalTab(event, 'v-group2')">
                  <i class="fas fa-microchip nav-icon-main"></i>
                  <div class="v-nav-text">
                      <span class="v-nav-rank">L·ª±a ch·ªçn #2</span>
                      <span class="v-nav-name">{{ second_cluster_name }}</span>
                  </div>
              </button>
          </div>

          <div class="vertical-content-area-polished">
            <!-- L·ª±a ch·ªçn #1 -->
            <div id="v-group1" class="v-content-pane active">
                <div class="pane-header-polished group-1-theme">
                    {{ top_analysis_html|safe }}
                </div>
            </div>

            <!-- L·ª±a ch·ªçn #2 -->
            <div id="v-group2" class="v-content-pane">
                <div class="pane-header-polished group-2-theme">
                    {{ second_analysis_html|safe }}
                </div>
            </div>
          </div>
      </div>
    </div>
  </div>
</main>

<script>
  function showTab(tabId) {
    const tabs = document.querySelectorAll(".tab");
    const contents = document.querySelectorAll(".tab-content");
    tabs.forEach(btn => btn.classList.remove("active"));
    contents.forEach(c => {
      c.classList.remove("active");
      c.style.opacity = "0";
    });
    const selectedTab = document.querySelector(`.tab[onclick="showTab('${tabId}')"]`);
    const selectedContent = document.getElementById(tabId);
    selectedTab.classList.add("active");
    selectedContent.classList.add("active");
    setTimeout(() => {
      selectedContent.style.opacity = "1";
    }, 50);
  }

  document.addEventListener("DOMContentLoaded", () => {
    document.querySelectorAll(".fill").forEach(bar => {
      const percentage = bar.dataset.percentage;
      bar.style.width = "0%";
      setTimeout(() => {
        bar.style.width = `${percentage}%`;
      }, 300);
    });
  });

  function switchVerticalTab(event, paneId) {
    document.querySelectorAll('.v-content-pane').forEach(pane => {
      pane.classList.remove('active');
    });
    document.querySelectorAll('.v-nav-item-polished').forEach(btn => {
      btn.classList.remove('active');
    });
    const activePane = document.getElementById(paneId);
    activePane.classList.add('active');
    event.currentTarget.classList.add('active');
    animateProgressCircle(activePane);
  }

  function animateProgressCircle(pane) {
    const wrapper = pane.querySelector('.progress-circle-wrapper');
    if (!wrapper) return;
    const score = parseInt(wrapper.dataset.score, 10);
    const indicator = wrapper.querySelector('.progress-ring-indicator');
    const radius = indicator.r.baseVal.value;
    const circumference = 2 * Math.PI * radius;
    const offset = circumference - (score / 100) * circumference;
    indicator.style.strokeDasharray = `${circumference} ${circumference}`;
    indicator.style.strokeDashoffset = circumference;
    setTimeout(() => {
      indicator.style.strokeDashoffset = offset;
    }, 10);
  }

  document.addEventListener('DOMContentLoaded', () => {
    const initialActivePane = document.querySelector('.v-content-pane.active');
    if (initialActivePane) {
      animateProgressCircle(initialActivePane);
    }
  });

  function switchSpotlightCard(cardIdToShow) {
    const allCards = document.querySelectorAll('.profile-spotlight-card');
    allCards.forEach(card => {
      card.classList.remove('active');
    });
    const cardToShow = document.getElementById(cardIdToShow);
    if (cardToShow) {
      cardToShow.classList.add('active');
    }
  }
  function restructurePaneContent(paneElement) {
    // 1. T√¨m th·∫ª cha ch·ª©a header c√≥ m√†u n·ªÅn
    const headerContainer = paneElement.querySelector('.pane-header-polished');
    if (!headerContainer) return; // N·∫øu kh√¥ng c√≥ th√¨ tho√°t

    // 2. T√¨m c√°c ph·∫ßn content ƒëang n·∫±m sai v·ªã tr√≠ (b√™n trong header)
    const contentList = headerContainer.querySelector('.analysis-step-list');
    const conclusion = headerContainer.querySelector('.analysis-conclusion');

    // 3. Di chuy·ªÉn c√°c ph·∫ßn content n√†y ra ngo√†i, l√†m con c·ªßa th·∫ª v-content-pane
    // JS s·∫Ω t·ª± ƒë·ªông di chuy·ªÉn ph·∫ßn t·ª≠ t·ª´ v·ªã tr√≠ c≈© sang v·ªã tr√≠ m·ªõi
    if (contentList && !contentList.parentElement.classList.contains('v-content-pane')) {
      paneElement.appendChild(contentList);
    }
    if (conclusion && !conclusion.parentElement.classList.contains('v-content-pane')) {
      paneElement.appendChild(conclusion);
    }
  }

  // --- C√ÅC H√ÄM C≈® ƒê∆Ø·ª¢C C·∫¨P NH·∫¨T ---

  function showTab(tabId) {
    const tabs = document.querySelectorAll(".tab");
    const contents = document.querySelectorAll(".tab-content");
    tabs.forEach(btn => btn.classList.remove("active"));
    contents.forEach(c => {
      c.classList.remove("active");
      c.style.opacity = "0";
    });
    const selectedTab = document.querySelector(`.tab[onclick="showTab('${tabId}')"]`);
    const selectedContent = document.getElementById(tabId);
    selectedTab.classList.add("active");
    selectedContent.classList.add("active");
    setTimeout(() => {
      selectedContent.style.opacity = "1";
    }, 50);
  }

  function switchVerticalTab(event, paneId) {
    document.querySelectorAll('.v-content-pane').forEach(pane => {
      pane.classList.remove('active');
    });
    document.querySelectorAll('.v-nav-item-polished').forEach(btn => {
      btn.classList.remove('active');
    });
    const activePane = document.getElementById(paneId);
    activePane.classList.add('active');
    event.currentTarget.classList.add('active');
    
    // C·∫¨P NH·∫¨T: G·ªçi h√†m t√°i c·∫•u tr√∫c cho tab v·ª´a ƒë∆∞·ª£c click
    restructurePaneContent(activePane); 

    animateProgressCircle(activePane);
  }

  function animateProgressCircle(pane) {
    const wrapper = pane.querySelector('.progress-circle-wrapper');
    if (!wrapper) return;
    const scoreText = wrapper.dataset.score || "0";
    const score = parseInt(scoreText.replace('%',''), 10);
    const indicator = wrapper.querySelector('.progress-ring-indicator');
    if (!indicator) return;
    const radius = indicator.r.baseVal.value;
    const circumference = 2 * Math.PI * radius;
    const offset = circumference - (score / 100) * circumference;
    indicator.style.strokeDasharray = `${circumference} ${circumference}`;
    indicator.style.strokeDashoffset = circumference;
    setTimeout(() => {
      indicator.style.strokeDashoffset = offset;
    }, 10);
  }

  function switchSpotlightCard(cardIdToShow) {
    const allCards = document.querySelectorAll('.profile-spotlight-card');
    allCards.forEach(card => {
      card.classList.remove('active');
    });
    const cardToShow = document.getElementById(cardIdToShow);
    if (cardToShow) {
      cardToShow.classList.add('active');
    }
  }

  // --- H√ÄM CH·∫†Y KHI T·∫¢I TRANG ---
  document.addEventListener("DOMContentLoaded", () => {
    // Ch·∫°y animation cho thanh ti·∫øn tr√¨nh ngang
    document.querySelectorAll(".fill").forEach(bar => {
      const percentage = bar.dataset.percentage;
      bar.style.width = "0%";
      setTimeout(() => {
        bar.style.width = `${percentage}%`;
      }, 300);
    });

    // C·∫¨P NH·∫¨T: T√¨m tab ƒëang active l√∫c t·∫£i trang v√† t√°i c·∫•u tr√∫c n√≥
    const initialActivePane = document.querySelector('.v-content-pane.active');
    if (initialActivePane) {
      restructurePaneContent(initialActivePane); // T√°i c·∫•u tr√∫c cho tab ƒë·∫ßu ti√™n
      animateProgressCircle(initialActivePane);   // Ch·∫°y animation v√≤ng tr√≤n
    }
  });
</script>
{% endblock %}