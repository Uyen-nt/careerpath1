{% load static %}
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Đặt Lại Mật Khẩu - CareerPath</title>
    <!-- Nhúng Font Awesome cho icon con mắt -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css"/>
    <!-- Link đến file CSS chung của bạn (nếu có) -->
    <link rel="stylesheet" href="{% static 'css/user.css' %}">

    <style>
        /* CSS riêng cho trang này, sử dụng các biến từ user.css */
        
        /* 1. Nền trang và font */
        body.page-reset-confirm {
            /* Sử dụng nền gradient từ user.css */
            background: var(--body-bg, linear-gradient(135deg, #28a745 0%, #ffc107 100%));
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            font-family: var(--font-primary, 'Be Vietnam Pro', sans-serif);
            margin: 0;
        }

        /* 2. Thẻ chứa form */
        .reset-card {
            background: var(--card-bg, white);
            padding: 40px 48px;
            border-radius: var(--border-radius-main, 24px);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            width: 100%;
            max-width: 450px;
        }

        /* 3. Tiêu đề */
        .reset-title {
            font-size: 1.875rem; /* 30px */
            font-weight: 700;
            color: var(--text-dark, #111827);
            text-align: center;
            margin-top: 0;
            margin-bottom: 35px;
        }

        /* 4. Nhóm input và các ô input */
        .input-group {
            position: relative;
            margin-bottom: 5px; 
        }

        .input-group input {
            width: 100%;
            padding: 14px 45px 14px 18px; 
            border: 1px solid var(--border-color, #d1d5db);
            border-radius: var(--border-radius-input, 10px);
            font-size: 1rem;
            transition: all 0.2s ease;
        }
        
        .input-group input:focus {
            outline: none;
            border-color: var(--primary-green, #28a745);
            box-shadow: 0 0 0 3px rgba(var(--primary-green-rgb, 40, 167, 69), 0.2);
        }

        .toggle-password {
            position: absolute;
            top: 50%;
            right: 15px;
            transform: translateY(-50%);
            background: none;
            border: none;
            cursor: pointer;
            color: var(--text-light, #9ca3af);
            font-size: 1.1rem;
        }
        
        /* 5. Nút submit */
        .btn-submit {
            width: 100%;
            padding: 14px;
            /* Sử dụng nền gradient từ user.css */
            background: var(--body-bg, linear-gradient(135deg, #28a745 0%, #ffc107 100%));
            border-radius: var(--border-radius-btn, 12px);
            border: none;
            color: white;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 20px;
        }
        .btn-submit:hover {
            transform: translateY(-2px);
            box-shadow: 0 7px 15px -5px rgba(var(--primary-green-rgb, 40, 167, 69), 0.4);
        }

        a.btn-submit:hover {
            color: #ffffff; /* Hoặc 'white' */
        }

        /* 6. Link quay lại */
        .back-link {
            display: block;
            text-align: center;
            margin-top: 20px;
            color: var(--text-medium, #6B7280);
            font-weight: 500;
            text-decoration: none;
            font-size: 0.9rem;
        }
        .back-link:hover {
            color: var(--primary-green, #28a745);
        }

        /* 7. CSS cho vùng chứa lỗi */
        .error-container {
            min-height: 20px;
            padding: 4px 0;
        }
        .error-text {
            /* Sử dụng màu lỗi từ user.css */
            color: var(--error-color, #DC3545);
            font-size: 0.85rem;
            font-weight: 500;
        }

        .error-icon {
            color: var(--error-color, #ef4444);
            font-size: 48px;
            margin-bottom: 20px;
        }
        
        /* CSS cho toast giữ nguyên, nó đã sử dụng màu đúng */
        #toast-container { position: fixed; bottom: 24px; right: 24px; z-index: 9999; display: flex; flex-direction: column; gap: 16px; }
        .toast { display: flex; align-items: center; gap: 12px; width: 380px; max-width: 90vw; background-color: white; border-radius: 8px; padding: 16px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15); overflow: hidden; position: relative; transform: translateX(calc(100% + 24px)); transition: transform 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55); }
        .toast.show { transform: translateX(0); }
        .toast-icon svg { width: 28px; height: 28px; flex-shrink: 0; }
        .toast-message { font-size: 1rem; font-weight: 400; color: #4B5563; line-height: 1.4; flex-grow: 1; }
        .toast-close { background: none; border: none; font-size: 24px; color: #9ca3af; cursor: pointer; line-height: 1; padding: 4px; }
        .toast-progress { position: absolute; bottom: 0; left: 0; right: 0; height: 5px; background-color: #e5e7eb; }
        .toast-progress-bar { height: 100%; width: 100%; border-radius: 5px; }
        .toast.success .toast-progress-bar { background-color: var(--primary-green, #28a745); }
        .toast.error .toast-progress-bar { background-color: var(--error-color, #DC3545); }
        @keyframes progress-countdown { from { width: 100%; } to { width: 0%; } }
        .toast.show .toast-progress-bar { animation: progress-countdown 5s linear forwards; animation-play-state: running; }
    </style>
</head>
<body class="page-reset-confirm">
    {% if validlink %}
    <div class="reset-card">
        <h1 class="reset-title">Đặt lại mật khẩu</h1>
        <form method="post" id="reset-confirm-form" novalidate>
            {% csrf_token %}

            <div class="input-group">
                {{ form.new_password1 }}
                <button type="button" class="toggle-password"><i class="fas fa-eye"></i></button>
            </div>
            <!-- ✅ Thêm container cho lỗi của trường 1 -->
            <div class="error-container" data-field="new_password1"></div>

            <div class="input-group">
                {{ form.new_password2 }}
                <button type="button" class="toggle-password"><i class="fas fa-eye"></i></button>
            </div>
            <!-- ✅ Thêm container cho lỗi của trường 2 và lỗi chung -->
            <div class="error-container" data-field="new_password2"></div>
            <div class="error-container" data-field="__all__"></div>

            <button type="submit" class="btn-submit">Đặt lại mật khẩu</button>
            <a href="{% url 'users:login' %}" class="back-link">Quay về trang đăng nhập</a>
        </form>
    </div>
    {% else %}
    <div class="reset-card">
            <div style="text-align: center;">
                <!-- Tùy chọn: Thêm icon lỗi cho trực quan -->
                <div class="error-icon">
                    <i class="fas fa-exclamation-triangle"></i>
                </div>

                <h1 class="reset-title">Liên kết không hợp lệ</h1>
                
                <p style="color: var(--text-medium, #4B5563); line-height: 1.6; font-size: 1rem; margin-bottom: 30px;">
                    Liên kết đặt lại mật khẩu này có thể đã hết hạn hoặc đã được sử dụng. Vui lòng quay lại trang đăng nhập và yêu cầu một liên kết mới.
                </p>
                
                <a href="{% url 'users:login' %}" class="btn-submit" style="text-decoration: none; display: inline-block; width: auto; padding: 12px 32px;">
                    Quay lại đăng nhập
                </a>
            </div>
        </div>
    {% endif %}

    <div id="toast-container"></div>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // --- LOGIC HIỆN/ẨN MẬT KHẨU ---
        document.querySelectorAll('.toggle-password').forEach(button => {
            button.addEventListener('click', function() {
                const input = this.previousElementSibling;
                const type = input.getAttribute('type') === 'password' ? 'text' : 'password';
                input.setAttribute('type', type);
                this.querySelector('i').classList.toggle('fa-eye');
                this.querySelector('i').classList.toggle('fa-eye-slash');
            });
        });

        // ✅ HÀM MỚI: Xóa tất cả các lỗi cũ trên form
        function clearFormErrors() {
            document.querySelectorAll('.error-container').forEach(container => {
                container.innerHTML = '';
            });
        }
        
        // ✅ HÀM MỚI: Hiển thị các lỗi mới từ JSON
        function displayFormErrors(errors) {
            for (const field in errors) {
                const errorContainer = document.querySelector(`.error-container[data-field="${field}"]`);
                if (errorContainer) {
                    const errorList = errors[field];
                    const errorMessage = errorList[0].message; // Lấy lỗi đầu tiên
                    errorContainer.innerHTML = `<p class="error-text">${errorMessage}</p>`;
                }
            }
        }

        // --- CẬP NHẬT PLACEHOLDER CHO CÁC Ô INPUT ---
        const pass1 = document.getElementById('id_new_password1');
        const pass2 = document.getElementById('id_new_password2');
        if (pass1) pass1.placeholder = 'Mật khẩu mới *';
        if (pass2) pass2.placeholder = 'Xác nhận mật khẩu *';
        
        // --- HÀM SHOW TOAST (Đã có pause on hover) ---
        const toastContainer = document.getElementById('toast-container');
        function showToast(message, type = 'success', duration = 5000) {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            const iconSvg = type === 'success' 
                ? `<svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 22C17.5228 22 22 17.5228 22 12C22 6.47715 17.5228 2 12 2C6.47715 2 2 6.47715 2 12C2 17.5228 6.47715 22 12 22Z" fill="#28A745"></path><path d="M9.5 11.5L11.5 13.5L14.5 10.5" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path></svg>`
                : `<svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 22C17.5228 22 22 17.5228 22 12C22 6.47715 17.5228 2 12 2C6.47715 2 2 6.47715 2 12C2 17.5228 6.47715 22 12 22Z" fill="#DC3545"></path><path d="M14.5 9.5L9.5 14.5" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path><path d="M9.5 9.5L14.5 14.5" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path></svg>`;

            toast.innerHTML = `<div class="toast-icon">${iconSvg}</div><p class="toast-message">${message}</p><button class="toast-close">×</button><div class="toast-progress"><div class="toast-progress-bar"></div></div>`;
            toastContainer.appendChild(toast);
            
            let autoCloseTimer, remainingTime = duration, startTime;
            const progressBar = toast.querySelector('.toast-progress-bar');
            const hideToast = () => { toast.classList.remove('show'); toast.addEventListener('transitionend', () => toast.remove(), { once: true }); };
            const pauseTimer = () => { clearTimeout(autoCloseTimer); remainingTime -= (Date.now() - startTime); progressBar.style.animationPlayState = 'paused'; };
            const resumeTimer = () => { startTime = Date.now(); progressBar.style.animationPlayState = 'running'; autoCloseTimer = setTimeout(hideToast, remainingTime); };
            toast.addEventListener('mouseenter', pauseTimer);
            toast.addEventListener('mouseleave', resumeTimer);
            toast.querySelector('.toast-close').addEventListener('click', () => { clearTimeout(autoCloseTimer); hideToast(); });
            setTimeout(() => { toast.classList.add('show'); resumeTimer(); }, 10);
        }

        // --- LOGIC SUBMIT FORM BẰNG AJAX ---
        const resetForm = document.getElementById('reset-confirm-form');
        if (resetForm) {
            resetForm.addEventListener('submit', function(e) {
                e.preventDefault();
                clearFormErrors(); // ✅ Xóa lỗi cũ trước khi gửi
                const formData = new FormData(resetForm);

                fetch(window.location.href, {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-CSRFToken': formData.get('csrfmiddlewaretoken'),
                        'X-Requested-With': 'XMLHttpRequest',
                    }
                })
                .then(response => response.json().then(data => ({ ok: response.ok, data })))
                .then(({ ok, data }) => {
                    if (ok) {
                        showToast(data.message, 'success');
                        setTimeout(() => {
                            window.location.href = "{% url 'users:login' %}";
                        }, 2000);
                    } else {
                        // Hiển thị lỗi trong form nếu có, hoặc toast nếu không
                        if (data.errors) {
                            displayFormErrors(data.errors);
                        } else {
                            showToast(data.message || 'Đã có lỗi xảy ra.', 'error');
                        }
                    }
                })
                .catch(error => {
                    console.error('Fetch Error:', error);
                    showToast('Lỗi kết nối. Vui lòng thử lại.', 'error');
                });
            });
        }
    });
    </script>
</body>
</html>