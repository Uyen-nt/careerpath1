{% extends "base.html" %}
{% load static %}

{% block title %}Trang c√° nh√¢n{% endblock %}

{% block content %}
<link rel="stylesheet" href="{% static 'css/user.css' %}">
<div class="profile-v4-wrapper">
    <div class="profile-v4-container">
        
        <header class="profile-tabs">
            <button class="tab-link active" data-tab="personal-info">
                <i class="fas fa-user-circle"></i><span>Th√¥ng tin c√° nh√¢n</span>
            </button>
            <button class="tab-link" data-tab="test-results">
                <i class="fas fa-poll-h"></i><span>K·∫øt qu·∫£ tr·∫Øc nghi·ªám</span>
            </button>
        </header>

        <main class="profile-v4-content">
            
            <div class="tab-content active" id="personal-info">
                <div class="info-tab-layout">
                    
                    <aside class="info-tab-sidebar">
                        <!-- ... (Ph·∫ßn avatar gi·ªØ nguy√™n) ... -->
                        <div class="info-avatar-wrapper" id="avatar-wrapper">
                            {% if user.avatar %}
                                <img src="{{ user.avatar.url }}" alt="·∫¢nh ƒë·∫°i di·ªán" class="info-avatar" id="profile-avatar-img">
                            {% else %}
                                <div class="info-avatar-placeholder">
                                    <span>{{ user.username|first|upper }}</span>
                                </div>
                            {% endif %}
                            
                            <form id="avatar-upload-form" style="display: none;">
                                {% csrf_token %}
                                <input type="file" id="avatar-input" name="avatar" accept="image/*">
                            </form>
                            <label for="avatar-input" class="info-avatar-upload-btn" title="Thay ƒë·ªïi ·∫£nh ƒë·∫°i di·ªán">
                                <i class="fas fa-camera"></i>
                            </label>
                            
                            <div class="avatar-loader" id="avatar-loader"><div class="spinner"></div></div>
                        </div>
                    </aside>

                    <!-- C·ªôt ph·∫£i c·ªßa tab: B·∫£ng th√¥ng tin chi ti·∫øt -->
                    <div class="info-tab-details">
                        
                        <!-- =========== VIEW HI·ªÇN TH·ªä TH√îNG TIN (M·∫∂C ƒê·ªäNH) =========== -->
                        <div id="display-info-view">
                            <div class="info-header">
                                <h3>Th√¥ng tin c∆° b·∫£n</h3>
                                <button id="edit-profile-btn" class="btn-edit-inline">
                                    <i class="fas fa-pencil-alt"></i>
                                    <span>Ch·ªânh s·ª≠a</span>
                                </button>
                            </div>
                            <table class="info-table">
                                <tbody>
                                    <tr>
                                        <td class="label"><i class="fas fa-user"></i> H·ªç v√† t√™n</td>
                                        <td class="value" id="display-fullname">{{ user.first_name }} {{ user.last_name }}</td>
                                    </tr>
                                    <tr>
                                        <td class="label"><i class="fas fa-user-tag"></i> T√™n ng∆∞·ªùi d√πng</td>
                                        <!-- [THAY ƒê·ªîI 1]: Th√™m ID v√†o ƒë√¢y -->
                                        <td class="value" id="display-username">{{ user.username }}</td>
                                    </tr>
                                    <tr>
                                        <td class="label"><i class="fas fa-envelope"></i> Email</td>
                                        <td class="value" id="display-email">{{ user.email }}</td>
                                    </tr>
                                    <tr>
                                        <td class="label"><i class="fas fa-calendar-alt"></i> Ng√†y tham gia</td>
                                        <td class="value">{{ user.date_joined|date:"d/m/Y" }}</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <!-- =========== VIEW CH·ªàNH S·ª¨A TH√îNG TIN (M·∫∂C ƒê·ªäNH ·∫®N) =========== -->
                        <div id="edit-info-view" style="display: none;">
                             <div class="info-header">
                                <h3>Ch·ªânh s·ª≠a th√¥ng tin</h3>
                            </div>
                            <form id="profile-edit-form">
                                {% csrf_token %}
                                <table class="info-table editable">
                                    <tbody>
                                        <tr>
                                            <td class="label"><i class="fas fa-user"></i> H·ªç</td>
                                            <td class="value">
                                                <input type="text" name="last_name" class="form-control-inline" value="{{ user.last_name }}">
                                            </td>
                                        </tr>
                                        <tr>
                                            <td class="label"><i class="fas fa-user"></i> T√™n</td>
                                            <td class="value">
                                                <input type="text" name="first_name" class="form-control-inline" value="{{ user.first_name }}">
                                            </td>
                                        </tr>
                                        <tr>
                                            <td class="label"><i class="fas fa-user-tag"></i> T√™n ng∆∞·ªùi d√πng</td>
                                            <td class="value">
                                                <!-- [THAY ƒê·ªîI 2]: X√≥a readonly, disabled v√† title -->
                                                <input type="text" name="username" class="form-control-inline" value="{{ user.username }}">
                                            </td>
                                        </tr>
                                        <tr>
                                            <td class="label"><i class="fas fa-envelope"></i> Email</td>
                                            <td class="value">
                                                <input type="email" name="email" class="form-control-inline" value="{{ user.email }}">
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                                <div class="form-actions">
                                    <button type="button" id="cancel-edit-btn" class="btn btn-secondary">H·ªßy</button>
                                    <button type="submit" id="save-profile-btn" class="btn btn-primary">L∆∞u thay ƒë·ªïi</button>
                                </div>
                            </form>
                        </div>

                    </div>
                </div>
            </div>

            <!-- ======== TAB 2: L·ªäCH S·ª¨ K·∫æT QU·∫¢ TR·∫ÆC NGHI·ªÜM (ƒê√É C·∫¨P NH·∫¨T) ======== -->
            <div class="tab-content" id="test-results">

                <!-- ==== PH·∫¶N 1: H·ªåC SINH (KI·ªÇU TI√äU ƒê·ªÄ CHIP) ==== -->
                <div class="history-group">
                    <h5 class="history-group-title theme-highschool">üßë‚Äçüéì L·ªãch s·ª≠ tr·∫Øc nghi·ªám h·ªçc sinh</h5>
                    {% if quiz_history_highschool %}
                        <div class="quiz-history-list-v2">
                            {% for quiz in quiz_history_highschool %}
                            <!-- ... n·ªôi dung l·∫∑p for gi·ªØ nguy√™n ... -->
                            <div class="quiz-history-item-v2">
                                <div class="card-date">
                                    <span class="day">{{ quiz.created_at|date:"d" }}</span>
                                    <span class="month-year">{{ quiz.created_at|date:"M Y" }}</span>
                                </div>
                                <div class="card-info">
                                    <div class="info-row top-result-row">
                                        <i class="fas fa-trophy icon-gold"></i>
                                        <p>Ph√π h·ª£p nh·∫•t: <strong>{{ quiz.top_cluster_name }}</strong></p>
                                        <span class="percentage-badge primary">{{ quiz.top_percentage }}%</span>
                                    </div>
                                    <div class="info-row">
                                        <i class="fas fa-medal icon-silver"></i>
                                        <p>Ph√π h·ª£p th·ª© hai: <strong>{{ quiz.second_cluster_name }}</strong></p>
                                        <span class="percentage-badge secondary">{{ quiz.second_percentage }}%</span>
                                    </div>
                                </div>
                                <div class="card-actions">
                                    <form method="get" action="{% url 'quiz_highschool:ket_qua' %}">
                                        <input type="hidden" name="quiz_id" value="{{ quiz.id }}">
                                        <button type="submit" class="btn-view-details" aria-label="Xem chi ti·∫øt k·∫øt qu·∫£ ng√†y {{ quiz.created_at|date:'d-m-Y' }}">
                                            Xem chi ti·∫øt <i class="fas fa-arrow-right"></i>
                                        </button>
                                    </form>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="results-placeholder">
                            <i class="fas fa-file-alt"></i>
                            <p>Ch∆∞a c√≥ k·∫øt qu·∫£ tr·∫Øc nghi·ªám.</p>
                        </div>
                    {% endif %}
                </div>

                <!-- ƒê∆∞·ªùng k·∫ª ngang ph√¢n c√°ch -->
                <hr class="section-separator">

                <!-- ==== PH·∫¶N 2: SINH VI√äN (KI·ªÇU TI√äU ƒê·ªÄ CHIP) ==== -->
                <div class="history-group">
                    <h5 class="history-group-title theme-university">üéì L·ªãch s·ª≠ tr·∫Øc nghi·ªám sinh vi√™n</h5>
                    {% if quiz_history_university %}
                        <div class="quiz-history-list-v2">
                            {% for quiz in quiz_history_university %}
                            <!-- ... n·ªôi dung l·∫∑p for gi·ªØ nguy√™n ... -->
                            <div class="quiz-history-item-v2">
                                <div class="card-date">
                                    <span class="day">{{ quiz.updated_at|date:"d" }}</span>
                                    <span class="month-year">{{ quiz.updated_at|date:"M Y" }}</span>
                                </div>
                                <div class="card-info">
                                    <div class="info-row">
                                        <i class="fas fa-briefcase icon-green"></i>
                                        <p>Nh√≥m ng√†nh ƒë√£ ch·ªçn: <strong>{{ quiz.selected_cluster_name }}</strong></p>
                                    </div>
                                    <div class="info-row readiness-score-row">
                                        <i class="fas fa-rocket icon-green"></i>
                                        <p>ƒêi·ªÉm s·∫µn s√†ng: <strong>{{ quiz.readiness_score }}%</strong></p>
                                    </div>
                                </div>
                                <div class="card-actions">
                                    <form method="get" action="{% url 'quiz_university:ket_qua_u' %}">
                                        <input type="hidden" name="quiz_id" value="{{ quiz.id }}">
                                        <button type="submit" class="btn-view-details" aria-label="Xem chi ti·∫øt k·∫øt qu·∫£ ng√†y {{ quiz.updated_at|date:'d-m-Y' }}">
                                            Xem chi ti·∫øt <i class="fas fa-arrow-right"></i>
                                        </button>
                                    </form>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="results-placeholder">
                            <i class="fas fa-file-alt"></i>
                            <p>Ch∆∞a c√≥ k·∫øt qu·∫£ tr·∫Øc nghi·ªám.</p>
                        </div>
                    {% endif %}
                </div>

            </div>
        </main>

        <!-- ========================================================== -->
        <!--   TH√äM M·ªöI: X√ìA T√ÄI KHO·∫¢N   -->
        <!-- ========================================================== -->
        
        <div class="profile-actions-footer">
            <button id="open-delete-modal-btn" class="btn btn-danger">X√≥a t√†i kho·∫£n</button>
        </div>

    </div> <!-- ƒê√¢y l√† th·∫ª ƒë√≥ng c·ªßa .profile-v4-container -->
</div> <!-- ƒê√¢y l√† th·∫ª ƒë√≥ng c·ªßa .profile-v4-wrapper -->


<!-- TH√äM M·ªöI: HTML C·ª¶A MODAL X√ÅC NH·∫¨N (ƒê·∫∑t ·ªü cu·ªëi file, tr∆∞·ªõc <script>) -->
<div id="delete-account-modal" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-header">
            <h3>B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a t√†i kho·∫£n?</h3>
            <button class="modal-close-btn">√ó</button>
        </div>
        <div class="modal-body">
            <!-- [THAY ƒê·ªîI 1]: B·ªè ph·∫ßn y√™u c·∫ßu nh·∫≠p li·ªáu -->
            <p>H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ƒë∆∞·ª£c ho√†n t√°c. T·∫•t c·∫£ d·ªØ li·ªáu c·ªßa b·∫°n s·∫Ω b·ªã x√≥a vƒ©nh vi·ªÖn.</p>
            <p>Xin h√£y ch·∫Øc ch·∫Øn tr∆∞·ªõc khi ti·∫øp t·ª•c.</p>
        </div>
        <div class="modal-footer">
            <button id="cancel-delete-btn" class="btn btn-secondary">H·ªßy b·ªè</button>
            <!-- [THAY ƒê·ªîI 2]: B·ªè thu·ªôc t√≠nh 'disabled' -->
            <button id="confirm-delete-btn" class="btn btn-danger">X√≥a t√†i kho·∫£n</button>
        </div>
    </div>
</div>
<div id="toast-container"></div>
<script>
document.addEventListener('DOMContentLoaded', function() {
    
    // ==========================================================
    // H√ÄM T·∫†O TOAST NOTIFICATION N√ÇNG CAO (VERSION 2.0)
    // ==========================================================
    function showToast(message, type = 'success', duration = 5000) {
        const container = document.getElementById('toast-container');
        if (!container) return;

        const toast = document.createElement('div');
        toast.className = `toast ${type}`;

        // Ch·ªçn icon v√† m√†u d·ª±a tr√™n 'type'
        const icons = {
            success: `
                <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <!-- V√≤ng tr√≤n n·ªÅn m√†u xanh -->
                    <circle cx="12" cy="12" r="11" fill="#28a745"/>
                    <!-- D·∫•u tick m√†u tr·∫Øng -->
                    <path d="M9 12.75L11.25 15 15 9.75" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" fill="none"/>
                </svg>`,
            error: `
                <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <!-- V√≤ng tr√≤n n·ªÅn m√†u ƒë·ªè -->
                    <circle cx="12" cy="12" r="11" fill="#EF4444"/>
                    <!-- D·∫•u X m√†u tr·∫Øng -->
                    <path d="M15 9l-6 6M9 9l6 6" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" fill="none"/>
                </svg>`
        };

        toast.innerHTML = `
            <div class="toast-icon">${icons[type]}</div>
            <div class="toast-message">${message}</div>
            <button class="toast-close">√ó</button>
            <div class="toast-progress"><div class="toast-progress-bar"></div></div>
        `;
        
        container.appendChild(toast);
        
        const progressBar = toast.querySelector('.toast-progress-bar');
        progressBar.style.animationDuration = `${duration / 1000}s`;

        let hideTimeout;
        let remainingTime = duration;
        let startTime = Date.now();

        const hideToast = () => {
            toast.classList.remove('show');
            toast.addEventListener('transitionend', () => {
                toast.remove();
            }, { once: true });
        };

        const startAutoClose = () => {
            hideTimeout = setTimeout(hideToast, remainingTime);
        };

        const pauseAutoClose = () => {
            clearTimeout(hideTimeout);
            remainingTime -= Date.now() - startTime;
            progressBar.style.animationPlayState = 'paused';
        };

        const resumeAutoClose = () => {
            startTime = Date.now();
            progressBar.style.animationPlayState = 'running';
            startAutoClose();
        };

        toast.addEventListener('mouseenter', pauseAutoClose);
        toast.addEventListener('mouseleave', resumeAutoClose);

        toast.querySelector('.toast-close').addEventListener('click', () => {
            clearTimeout(hideTimeout);
            hideToast();
        });

        // B·∫≠t toast m∆∞·ª£t
        setTimeout(() => {
            toast.classList.add('show');
            container.appendChild(toast);
            startTime = Date.now();
            startAutoClose();
        }, 50);
    }


    // ==========================================================
    // CODE LOGIC C≈® (GI·ªÆ NGUY√äN, V·∫™N D√ôNG showToast)
    // ==========================================================
    const tabLinks = document.querySelectorAll('.tab-link');
    const tabContents = document.querySelectorAll('.tab-content');

    tabLinks.forEach(link => {
        link.addEventListener('click', () => {
            const tabId = link.getAttribute('data-tab');
            tabLinks.forEach(item => item.classList.remove('active'));
            tabContents.forEach(item => item.classList.remove('active'));
            link.classList.add('active');
            document.getElementById(tabId).classList.add('active');
        });
    });

    const avatarInput = document.getElementById('avatar-input');
    const avatarWrapper = document.getElementById('avatar-wrapper');
    const avatarLoader = document.getElementById('avatar-loader');
    const avatarImg = document.getElementById('profile-avatar-img');
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

    if (avatarInput) {
        avatarInput.addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (!file) return;

            if (file.size > 2 * 1024 * 1024) {
                showToast('L·ªói: K√≠ch th∆∞·ªõc ·∫£nh kh√¥ng ƒë∆∞·ª£c v∆∞·ª£t qu√° 2MB.', 'error');
                this.value = ''; 
                return;
            }
            
            const formData = new FormData();
            formData.append('avatar', file);
            avatarLoader.style.display = 'flex';

            fetch("{% url 'users:ajax_update_avatar' %}", {
                method: 'POST',
                body: formData,
                headers: { 'X-CSRFToken': csrfToken, 'X-Requested-With': 'XMLHttpRequest' }
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    avatarImg.src = data.new_avatar_url;
                    const headerAvatar = document.getElementById('header-user-avatar');
                    if(headerAvatar) headerAvatar.src = data.new_avatar_url;
                    showToast('C·∫≠p nh·∫≠t ·∫£nh ƒë·∫°i di·ªán th√†nh c√¥ng!', 'success');
                } else {
                    showToast('L·ªói: ' + data.message, 'error');
                }
            })
            .catch(error => {
                console.error('L·ªói khi t·∫£i ·∫£nh l√™n:', error);
                showToast('ƒê√£ c√≥ l·ªói kh√¥ng mong mu·ªën x·∫£y ra. Vui l√≤ng th·ª≠ l·∫°i.', 'error');
            })
            .finally(() => {
                avatarLoader.style.display = 'none';
                this.value = ''; 
            });
        });
    }

    const displayView = document.getElementById('display-info-view');
    const editView = document.getElementById('edit-info-view');
    const editBtn = document.getElementById('edit-profile-btn');
    const cancelBtn = document.getElementById('cancel-edit-btn');
    const profileEditForm = document.getElementById('profile-edit-form');

    if (editBtn) {
        editBtn.addEventListener('click', () => {
            displayView.style.display = 'none';
            editView.style.display = 'block';
        });
    }

    if (cancelBtn) {
        cancelBtn.addEventListener('click', () => {
            displayView.style.display = 'block';
            editView.style.display = 'none';
            profileEditForm.reset(); 
        });
    }

    if (profileEditForm) {
        profileEditForm.addEventListener('submit', function(e) {
            e.preventDefault(); 
            const formData = new FormData(this);
            const saveButton = document.getElementById('save-profile-btn');
            const originalButtonText = saveButton.innerHTML;
            saveButton.disabled = true;
            saveButton.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> ƒêang l∆∞u...';

            fetch("{% url 'users:ajax_update_profile' %}", {
                method: 'POST',
                body: formData,
                headers: { 'X-Requested-With': 'XMLHttpRequest' }
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    document.getElementById('display-fullname').textContent = data.first_name + ' ' + data.last_name;
                    document.getElementById('display-email').textContent = data.email;
                    document.getElementById('display-username').textContent = data.username;

                    const headerUsername = document.querySelector('.header-username');
                    if (headerUsername) headerUsername.textContent = data.first_name + ' ' + data.last_name;

                    displayView.style.display = 'block';
                    editView.style.display = 'none';
                    showToast('C·∫≠p nh·∫≠t th√¥ng tin th√†nh c√¥ng!', 'success');
                } else {
                    showToast('L·ªói: ' + data.message, 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showToast('ƒê√£ c√≥ l·ªói x·∫£y ra. Vui l√≤ng th·ª≠ l·∫°i.', 'error');
            })
            .finally(() => {
                saveButton.disabled = false;
                saveButton.innerHTML = originalButtonText;
            });
        });
    }


    // ==========================================================
    // TH√äM M·ªöI: LOGIC X·ª¨ L√ù X√ìA T√ÄI KHO·∫¢N
    // ==========================================================
    const deleteModal = document.getElementById('delete-account-modal');
    const openModalBtn = document.getElementById('open-delete-modal-btn');
    const closeModalBtn = deleteModal.querySelector('.modal-close-btn');
    const cancelDeleteBtn = document.getElementById('cancel-delete-btn');
    const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
    const deleteFormCsrf = document.querySelector('[name=csrfmiddlewaretoken]'); // L·∫•y token t·ª´ m·ªôt form c√≥ s·∫µn

    function openModal() {
        if (deleteModal) deleteModal.classList.add('active');
    }

    function closeModal() {
        if (deleteModal) deleteModal.classList.remove('active');
    }

    if (openModalBtn) {
        openModalBtn.addEventListener('click', openModal);
    }
    if (closeModalBtn) {
        closeModalBtn.addEventListener('click', closeModal);
    }
    if (cancelDeleteBtn) {
        cancelDeleteBtn.addEventListener('click', closeModal);
    }
    if (deleteModal) {
        deleteModal.addEventListener('click', (event) => {
            if (event.target === deleteModal) {
                closeModal();
            }
        });
    }

    // G·ª≠i y√™u c·∫ßu x√≥a t√†i kho·∫£n
    if (confirmDeleteBtn) {
        confirmDeleteBtn.addEventListener('click', () => {
            // Kh√¥ng c·∫ßn l·∫•y d·ªØ li·ªáu t·ª´ form n·ªØa
            const formData = new FormData();
            // L·∫•y CSRF token t·ª´ m·ªôt form kh√°c tr√™n trang (v√≠ d·ª• form avatar)
            if (deleteFormCsrf) {
                formData.append('csrfmiddlewaretoken', deleteFormCsrf.value);
            }

            confirmDeleteBtn.disabled = true;
            confirmDeleteBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> ƒêang x·ª≠ l√Ω...';

            fetch("{% url 'users:ajax_delete_account' %}", {
                method: 'POST',
                body: formData,
                headers: { 'X-Requested-With': 'XMLHttpRequest' }
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    showToast(data.message, 'success');
                    // Ch·ªù 2 gi√¢y ƒë·ªÉ ng∆∞·ªùi d√πng th·∫•y th√¥ng b√°o r·ªìi m·ªõi chuy·ªÉn h∆∞·ªõng
                    setTimeout(() => {
                        window.location.href = data.redirect_url;
                    }, 2000);
                } else {
                    showToast(data.message, 'error');
                    confirmDeleteBtn.disabled = false;
                    confirmDeleteBtn.textContent = 'T√¥i hi·ªÉu, x√≥a t√†i kho·∫£n';
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showToast('C√≥ l·ªói x·∫£y ra, vui l√≤ng th·ª≠ l·∫°i.', 'error');
                confirmDeleteBtn.disabled = false;
                confirmDeleteBtn.textContent = 'T√¥i hi·ªÉu, x√≥a t√†i kho·∫£n';
            });
        });
    }

});
</script>
{% endblock %}